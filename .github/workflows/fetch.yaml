# å®šä¹‰ä¸€ä¸ª GitHub Actions çš„å·¥ä½œæµ
name: Fetch Subscriptions Source

# è§¦å‘æ¡ä»¶
on:
  # 1.æ‰‹åŠ¨æ‰§è¡Œï¼šåœ¨ GitHub ä»“åº“çš„ Actions é¡µé¢å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:

  # 2.å®šæ—¶ä»»åŠ¡æ‰§è¡Œ
  schedule:
    - cron: '0 */4 * * *'
  # è¯¥è§„åˆ™è¡¨ç¤ºæ¯å¤©ä» 0 ç‚¹å¼€å§‹ï¼Œæ¯éš” 4 ä¸ªå°æ—¶æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
  # - cron: '0 3,12 * * *'
  # ä½¿ç”¨ UTC æ—¶é—´ï¼Œè¡¨ç¤ºæ¯å¤© UTC æ—¶é—´ 3:00 å’Œ 12:00 æ‰§è¡Œ
  # è¡¨è¾¾å¼ç”Ÿæˆ  https://crontab.guru/

  # 3.ç›‘å¬ä»“åº“ star äº‹ä»¶ï¼šå½“æœ‰äººç»™è¿™ä¸ªä»“åº“ç‚¹ star æ—¶è‡ªåŠ¨æ‰§è¡Œ
  watch:
    types: started

# ä»»åŠ¡æµç¨‹
jobs:
  # ä»»åŠ¡æµåç§°
  fetch:
    # ç¯å¢ƒé…ç½®ï¼Œè¿è¡Œåœ¨æœ€æ–°çš„ ubuntu ç³»ç»Ÿä¸Š
    runs-on: ubuntu-latest
    
    # æ‰§è¡Œæ­¥éª¤
    steps:
    
    # 1.ä½¿ç”¨ checkout åŠ¨ä½œå°†ä»“åº“ä»£ç ä¸‹è½½åˆ°è¿è¡Œå™¨
    - name: è¿å‡ºä»£ç 
      uses: actions/checkout@v2

    # 2.ä½¿ç”¨ setup-python åŠ¨ä½œå®‰è£… Pythonï¼Œç‰ˆæœ¬ä¸º 3.xï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
    - name: å®‰è£…Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    # 3.ä½¿ç”¨ cache åŠ¨ä½œç¼“å­˜ pip çš„å®‰è£…åŒ…ï¼Œä»¥æé«˜åç»­è¿è¡Œæ•ˆç‡ã€‚ç¼“å­˜é”®æ ¹æ® requirements.txt çš„å“ˆå¸Œå€¼ç”Ÿæˆï¼Œå¦‚æœæ–‡ä»¶æœªæ”¹å˜ï¼Œåˆ™ä½¿ç”¨ç¼“å­˜ã€‚
    - name: åŠ è½½ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/run_in_Actions/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4.å°†ç³»ç»Ÿæ—¶åŒºè®¾ç½®ä¸ºäºšæ´²/ä¸Šæµ·ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - name: è®¾ç½®æ—¶åŒº
      run: sudo timedatectl set-timezone 'Asia/Shanghai'

    # 5.ä½¿ç”¨ pip å®‰è£… requirements.txt ä¸­æŒ‡å®šçš„ Python åŒ…
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r ./requirements.txt

    # 6.è¿è¡Œ main.py è„šæœ¬
    - name: æ‰§è¡Œä»»åŠ¡
      run: |
        python ./main.py

    # 7.é…ç½® git ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åå°† ./sub ç›®å½•çš„æ›´æ”¹æäº¤ï¼Œæäº¤ä¿¡æ¯åŒ…å«å½“å‰æ—¶é—´
    - name: Commit
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add ./sub   # è¿™æ˜¯pre_check.pyå®šä¹‰çš„è¾“å‡ºè·¯å¾„
        git commit -m "ğŸ€ çˆ¬å–å…è´¹è®¢é˜…æº $(date '+%Y-%m-%d %H:%M:%S')"

    # 8.ä½¿ç”¨ ad-m/github-push-action åŠ¨ä½œå°†æäº¤æ¨é€åˆ° main åˆ†æ”¯
    - name: æ¨é€æ›´æ”¹
      uses:  ad-m/github-push-action@master
      with:
         # github_token: ${{ secrets.TOKEN }}
         branch: main
         
